CartItemService

Сервис CartItemService реализует бизнес-логику, связанную с управлением товарами в корзине пользователя.
Он обеспечивает добавление, удаление, обновление и получение элементов корзины (CartItem),
взаимодействуя с сущностями
User, Product, Order и OrderItem. Сервис является частью слоя бизнес-логики приложения онлайн-магазина
садовой продукции.

Класс аннотирован @Service, что делает его Spring-компонентом, а аннотация @RequiredArgsConstructor позволяет внедрять зависимости
через конструктор. Все операции выполняются в транзакциях благодаря аннотации @Transactional.

Основное назначение

CartItemService обеспечивает удобную работу пользователя с корзиной покупок, автоматически создавая её при необходимости
и синхронизируя данные между сущностями Order (корзина) и OrderItem (позиции корзины).

Основные зависимости

• productRepository — доступ к товарам (Product) в базе данных.
• orderRepository — управление заказами (Order), включая открытые корзины.
• orderItemRepository — хранение и обновление элементов корзины (OrderItem).
• userService — получение текущего авторизованного пользователя.
• cartItemConverter — преобразование сущностей OrderItem в DTO и обратно.

Описание работы

1. addItemToCart(CartItemRequestDto)
   Добавляет товар в корзину текущего пользователя.
   - Проверяет корректность входных данных (наличие productId и количества).
   - Получает текущего пользователя из контекста безопасности.
   - Проверяет, есть ли товар уже в корзине.
       • Если товар найден — увеличивает количество.
       • Если нет — создаёт новый OrderItem, связанный с открытым заказом (Order).
   - Сохраняет изменения и возвращает DTO добавленного товара.

2. removeItemFromCart(Integer productId)
   Удаляет конкретный товар из корзины текущего пользователя.
   - Проверяет корректность ID.
   - Получает пользователя и текущую корзину.
   - Находит элемент OrderItem и удаляет его из репозитория.
   - Возвращает DTO удалённого элемента.

3. updateItemInCart(CartItemUpdateDto)
   Обновляет количество товара в корзине.
   - Проверяет корректность данных (наличие productId и количество > 0).
   - Находит нужный OrderItem.
   - Устанавливает новое количество и сохраняет изменения.
   - Возвращает обновлённое DTO.

4. getCartItems()
   Возвращает все элементы корзины текущего пользователя.
   - Получает пользователя и его открытую корзину.
   - Преобразует список OrderItem в список CartItemResponseDto и возвращает клиенту.

Вспомогательные методы

• getCurrentCart(User user)
  Возвращает открытую корзину пользователя.
  - Если корзина существует и имеет статус OPEN — возвращает её.
  - Если корзины нет — создаёт новую корзину (Order) со статусом OPEN и сохраняет её в базе.

• getOrderItemFromCart(User user, Integer productId)
  Возвращает конкретный элемент корзины по ID товара.
  - Ищет OrderItem в открытом заказе пользователя.
  - Если элемент не найден — выбрасывает исключение IllegalArgumentException.

Безопасность и транзакционность

Все методы сервиса работают в транзакциях, чтобы гарантировать целостность данных при изменении корзины.
Текущий пользователь определяется через userService.getCurrentUser(), который использует Spring Security.
Таким образом, операции над корзиной выполняются строго в контексте текущего авторизованного пользователя.


