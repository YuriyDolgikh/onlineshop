 CartService

Сервис CartService управляет полной информацией о корзине пользователя в онлайн-магазине.
Он обеспечивает очистку корзины, передачу её содержимого в заказ и получение полной информации о корзине
с подсчётом общей стоимости. Сервис работает с сущностями User, Order и OrderItem, а также конвертирует их в DTO
для передачи клиенту.

Класс аннотирован @Service, что делает его Spring-компонентом, а аннотация @RequiredArgsConstructor позволяет внедрять зависимости
через конструктор. Все методы работают в рамках транзакций благодаря @Transactional.

Основное назначение

CartService обеспечивает удобное управление корзиной пользователя, позволяя получать актуальное состояние корзины,
очищать её или переводить в заказ для дальнейшей оплаты.

Основные зависимости

• orderRepository — доступ к заказам (Order) пользователя, включая открытые корзины.
• userService — получение текущего авторизованного пользователя.
• orderItemRepository — управление элементами корзины (OrderItem).
• cartItemConverter — преобразование OrderItem в CartItemResponseDto.

Описание работы

1. clearCart()
   Полностью очищает корзину текущего пользователя.
   - Получает текущего пользователя и его открытую корзину.
   - Удаляет все элементы корзины через orderItemRepository.deleteAll().

2. transferToOrder()
   Переводит корзину пользователя в заказ со статусом PENDING_PAYMENT.
   - Получает пользователя и открытую корзину.
   - Проверяет, что корзина не пустая; если пустая — выбрасывает IllegalStateException.
   - Устанавливает статус заказа PENDING_PAYMENT и сохраняет изменения.

3. getCartFullData()
   Возвращает полную информацию о корзине текущего пользователя.
   - Получает открытую корзину и список элементов OrderItem.
   - Преобразует элементы в DTO с помощью cartItemConverter.
   - Считает общую стоимость корзины (умножение цены товара на количество и суммирование).
   - Возвращает CartResponseDto с идентификатором пользователя, списком элементов и общей суммой.

Вспомогательные методы

• getCurrentCart(User user)
  Возвращает открытую корзину пользователя.
  - Если корзина с статусом OPEN существует — возвращает её.
  - Если корзины нет — создаёт новую корзину со статусом OPEN и сохраняет её в базе.

Безопасность и транзакционность

Все методы работают в рамках транзакций, обеспечивая целостность данных при изменении корзины.
Текущий пользователь определяется через userService.getCurrentUser(), что обеспечивает работу строго в контексте авторизованного пользователя.

Обработка ошибок

Сервис выбрасывает IllegalStateException, если попытка перевода корзины в заказ выполняется при пустой корзине.
Это позволяет контролировать корректность бизнес-логики и предотвращает ошибки на уровне клиента.


